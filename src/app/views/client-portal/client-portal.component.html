@if (project(); as currentProject) {
  <c-row>
    <c-col xs="12">
      <c-card class="mb-4">
        <c-card-header>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1">Client Portal: {{ currentProject.name }}</h4>
              <p class="text-muted mb-0">{{ currentProject.client }}</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <c-badge [color]="getStatusColor(currentProject.status)">
                {{ currentProject.status }}
              </c-badge>
              <c-progress [value]="currentProject.progress" [color]="getStatusColor(currentProject.status)" class="ms-2" style="width: 150px;"></c-progress>
              <span class="text-muted small ms-2">{{ currentProject.progress }}%</span>
            </div>
          </div>
        </c-card-header>
        <c-card-body>
          <c-tabs [activeItemKey]="activeTab()" (activeItemKeyChange)="onTabChange($event)">
            <c-tabs-list variant="tabs">
              <button cTab [itemKey]="0">
                <svg cIcon class="me-2" name="cilChartLine"></svg>
                Progress
              </button>
              <button cTab [itemKey]="1">
                <svg cIcon class="me-2" name="cilFile"></svg>
                Report
              </button>
              <button cTab [itemKey]="2">
                <svg cIcon class="me-2" name="cilList"></svg>
                Action Plan
              </button>
              <button cTab [itemKey]="3">
                <svg cIcon class="me-2" name="cilPeople"></svg>
                Resources
              </button>
            </c-tabs-list>
            <c-tabs-content>
            <!-- Progress Tab -->
            <c-tab-panel class="p-4" [itemKey]="0">
              <h5 class="mb-4">Project Timeline</h5>
              <div class="position-relative">
                @for (step of timelineSteps(); track step.title; let last = $last) {
                  <div class="d-flex mb-4">
                    <div class="d-flex flex-column align-items-center me-3">
                      <div
                        class="rounded-circle d-flex align-items-center justify-content-center text-white"
                        [ngClass]="'bg-' + step.color"
                        [style.width.px]="40"
                        [style.height.px]="40"
                      >
                        @if (step.status === 'Completed') {
                          <svg cIcon name="cilCheck" size="sm"></svg>
                        } @else if (step.status === 'In Progress') {
                          <svg cIcon name="cilMediaPlay" size="sm"></svg>
                        } @else {
                          <span class="small fw-bold">{{ $index + 1 }}</span>
                        }
                      </div>
                      @if (!last) {
                        <div
                          class="border-start border-2 my-2"
                          [ngClass]="step.status === 'Completed' ? 'border-success' : 'border-secondary'"
                          [style.height.px]="60"
                        ></div>
                      }
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="mb-1">{{ step.title }}</h6>
                      <p class="mb-1 text-muted small">{{ step.date }}</p>
                      <c-badge [color]="step.color">{{ step.status }}</c-badge>
                      @if (step.description) {
                        <p class="mt-2 mb-0 small text-muted">{{ step.description }}</p>
                      }
                    </div>
                  </div>
                }
              </div>
            </c-tab-panel>

            <!-- Report Tab -->
            <c-tab-panel class="p-4" [itemKey]="1">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h5>Strategy Report</h5>
                <button cButton color="primary" variant="outline" (click)="downloadReport()">
                  <svg cIcon class="me-2" name="cilCloudDownload"></svg>
                  Download PDF
                </button>
              </div>
              @if (currentProject.report) {
                <div class="report-content">
                  @if (currentProject.report.executiveSummary) {
                    <div class="mb-4">
                      <h6 class="mb-3 text-primary">Executive Summary</h6>
                      <div class="bg-light p-4 rounded">
                        <p class="mb-0">{{ currentProject.report.executiveSummary }}</p>
                      </div>
                    </div>
                  }
                  @if (currentProject.report.sections && currentProject.report.sections.length > 0) {
                    @for (section of currentProject.report.sections; track section.title) {
                      <div class="mb-4">
                        <h6 class="mb-3">{{ section.title }}</h6>
                        <div class="bg-light p-4 rounded">
                          <p class="mb-0" [innerHTML]="section.content"></p>
                        </div>
                      </div>
                    }
                  }
                  @if (currentProject.report.recommendations && currentProject.report.recommendations.length > 0) {
                    <div class="mb-4">
                      <h6 class="mb-3 text-primary">Key Recommendations</h6>
                      <ul class="list-unstyled">
                        @for (rec of currentProject.report.recommendations; track rec) {
                          <li class="mb-2">
                            <svg cIcon name="cilCheckCircle" class="me-2 text-success"></svg>
                            {{ rec }}
                          </li>
                        }
                      </ul>
                    </div>
                  }
                </div>
              } @else {
                <div class="text-center py-5">
                  <svg cIcon name="cilFile" size="3xl" class="text-muted mb-3"></svg>
                  <p class="text-muted">Report is being prepared. Check back soon!</p>
                </div>
              }
            </c-tab-panel>

            <!-- Action Plan Tab -->
            <c-tab-panel class="p-4" [itemKey]="2">
              <h5 class="mb-4">Strategic Recommendations</h5>
              @if (currentProject.strategicActions && currentProject.strategicActions.length > 0) {
                <ul cListGroup>
                  @for (action of currentProject.strategicActions; track action.id) {
                    <li cListGroupItem>
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 me-2">{{ action.title }}</h6>
                            <c-badge [color]="getActionStatusColor(action.status)">
                              {{ action.status }}
                            </c-badge>
                          </div>
                          <p class="text-muted small mb-2">{{ action.description }}</p>
                          <div class="d-flex gap-3">
                            <small class="text-muted">
                              <svg cIcon name="cilTag" size="sm" class="me-1"></svg>
                              {{ action.category }}
                            </small>
                            <small class="text-muted">
                              <svg cIcon name="cilCalendar" size="sm" class="me-1"></svg>
                              {{ action.createdAt | date:'shortDate' }}
                            </small>
                          </div>
                        </div>
                      </div>
                    </li>
                  }
                </ul>
              } @else {
                <div class="text-center py-5">
                  <svg cIcon name="cilList" size="3xl" class="text-muted mb-3"></svg>
                  <p class="text-muted">No strategic actions defined yet.</p>
                </div>
              }
            </c-tab-panel>

            <!-- Resources Tab -->
            <c-tab-panel class="p-4" [itemKey]="3">
              <h5 class="mb-4">Assigned Resources</h5>
              @if (assignedResources().length > 0) {
                <c-row>
                  @for (resource of assignedResources(); track resource.id) {
                    <c-col md="6" class="mb-3">
                      <c-card>
                        <c-card-body>
                          <div class="d-flex align-items-start">
                            <div
                              class="d-inline-flex align-items-center justify-content-center rounded-circle text-white me-3"
                              [ngClass]="'bg-' + getAvatarColor(resource.fullName)"
                              [style.width.px]="60"
                              [style.height.px]="60"
                              [style.font-size.rem]="1.5"
                              [style.font-weight]="'bold'"
                            >
                              {{ getInitials(resource.fullName) }}
                            </div>
                            <div class="flex-grow-1">
                              <h6 class="mb-1">{{ resource.fullName }}</h6>
                              <p class="mb-1 small text-muted">{{ resource.role }}</p>
                              @if (resource.company) {
                                <p class="mb-2 small text-muted">
                                  <svg cIcon name="cilBuilding" size="sm" class="me-1"></svg>
                                  {{ resource.company }}
                                </p>
                              }
                              <div class="d-flex flex-column gap-1">
                                <a
                                  href="mailto:{{ resource.email }}"
                                  class="small text-decoration-none"
                                >
                                  <svg cIcon name="cilEnvelope" size="sm" class="me-1"></svg>
                                  {{ resource.email }}
                                </a>
                                @if (resource.phone) {
                                  <a
                                    href="tel:{{ resource.phone }}"
                                    class="small text-decoration-none"
                                  >
                                    <svg cIcon name="cilPhone" size="sm" class="me-1"></svg>
                                    {{ resource.phone }}
                                  </a>
                                }
                              </div>
                            </div>
                          </div>
                        </c-card-body>
                      </c-card>
                    </c-col>
                  }
                </c-row>
              } @else {
                <div class="text-center py-5">
                  <svg cIcon name="cilPeople" size="3xl" class="text-muted mb-3"></svg>
                  <p class="text-muted">No resources assigned yet.</p>
                </div>
              }
            </c-tab-panel>
          </c-tabs-content>
        </c-tabs>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
} @else {
  <c-row>
    <c-col xs="12">
      <c-card>
        <c-card-body class="text-center py-5">
          <svg cIcon name="cilWarning" size="3xl" class="text-warning mb-3"></svg>
          <h5>Project Not Found</h5>
          <p class="text-muted">The requested project could not be found.</p>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
}

