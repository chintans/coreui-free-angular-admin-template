@if (isSuperAdmin()) {
  <!-- Super Admin: Marketplace Analytics -->
  <c-row class="mb-4">
    <c-col xs="12">
      <h2 class="mb-4">Marketplace Analytics & Management</h2>
    </c-col>
  </c-row>

  <c-row class="mb-4">
    <c-col sm="6" xl="3">
      <c-widget-stat-b class="mb-4" color="primary" inverse text="Total Contractors" title="Contractors" [value]="analytics().totalContractors.toString()">
        <c-progress class="my-2" thin [value]="100" white />
      </c-widget-stat-b>
    </c-col>
    <c-col sm="6" xl="3">
      <c-widget-stat-b class="mb-4" color="info" inverse text="Agency Contractors" title="Agencies" [value]="analytics().agencyContractors.toString()">
        <c-progress class="my-2" thin [value]="75" white />
      </c-widget-stat-b>
    </c-col>
    <c-col sm="6" xl="3">
      <c-widget-stat-b class="mb-4" color="success" inverse text="Independent Contractors" title="Independent" [value]="analytics().independentContractors.toString()">
        <c-progress class="my-2" thin [value]="50" white />
      </c-widget-stat-b>
    </c-col>
    <c-col sm="6" xl="3">
      <c-widget-stat-b class="mb-4" color="warning" inverse text="Engagement Rate" title="Engagement" [value]="analytics().marketplaceEngagementRate.toString() + '%'">
        <c-progress class="my-2" thin [value]="analytics().marketplaceEngagementRate" white />
      </c-widget-stat-b>
    </c-col>
  </c-row>

  <c-row class="mb-4">
    <c-col xs="12" lg="6">
      <c-card class="mb-4">
        <c-card-header>
          <div class="d-flex justify-content-between align-items-center">
            <h5>Top Matched Entities</h5>
          </div>
        </c-card-header>
        <c-card-body>
          @if (analytics().topMatchedEntities.length === 0) {
            <p class="text-muted mb-0">No matched entities yet</p>
          } @else {
            <table cTable hover responsive>
              <thead>
                <tr>
                  <th>Entity Name</th>
                  <th>Type</th>
                  <th>Matches</th>
                  <th>Engagement</th>
                </tr>
              </thead>
              <tbody>
                @for (entity of analytics().topMatchedEntities; track entity.id) {
                  <tr>
                    <td>{{ entity.name }}</td>
                    <td>
                      <c-badge [color]="entity.type === 'Agency' ? 'primary' : 'secondary'">
                        {{ entity.type }}
                      </c-badge>
                    </td>
                    <td>{{ entity.matchCount }}</td>
                    <td>{{ entity.engagementRate }}%</td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </c-card-body>
      </c-card>
    </c-col>
    <c-col xs="12" lg="6">
      <c-card class="mb-4">
        <c-card-header>
          <div class="d-flex justify-content-between align-items-center">
            <h5>Contractor Management</h5>
            <button cButton color="primary" size="sm" (click)="navigateToAddContractor()">
              <svg cIcon class="me-2" name="cilPlus"></svg>
              Add Contractor
            </button>
          </div>
        </c-card-header>
        <c-card-body>
          <table cTable hover responsive>
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Rating</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (provider of marketplaceService.providers(); track provider.id) {
                <tr>
                  <td>{{ provider.name }}</td>
                  <td>
                    <c-badge [color]="provider.type === 'Agency' ? 'primary' : 'secondary'">
                      {{ provider.type }}
                    </c-badge>
                  </td>
                  <td>{{ provider.rating }}</td>
                  <td>
                    <button cButton color="link" size="sm" [routerLink]="['/marketplace/contractors', provider.id, 'edit']">
                      <svg cIcon name="cilPencil"></svg>
                    </button>
                    <button cButton color="link" size="sm" (click)="confirmDelete(provider.id)">
                      <svg cIcon name="cilTrash"></svg>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
}

<c-row>
  <c-col xs="12">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="mb-1">Actionable Marketplace</h3>
        <p class="text-muted small mb-0">Connect strategy to execution with curated service providers</p>
      </div>
    </div>

    <!-- Filters Section -->
    <c-card class="mb-4">
      <c-card-body>
        <c-row class="g-3">
          <c-col xs="12" md="6">
            <label cLabel class="mb-2">Search Providers</label>
            <c-input-group>
              <span cInputGroupText>
                <svg cIcon name="cilMagnifyingGlass"></svg>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="Search by name, skills, or description..."
                [value]="searchQuery()"
                (input)="onSearchChange($event)"
              />
            </c-input-group>
          </c-col>
          <c-col xs="12" md="6">
            <label cLabel class="mb-2">Filter by Category</label>
            <select
              class="form-select"
              [value]="selectedCategory() ?? ''"
              (change)="onCategoryChange($any($event.target).value || null)"
            >
              <option value="">All Categories</option>
              @for (category of availableCategories(); track category) {
                <option [value]="category">{{ category }}</option>
              }
            </select>
          </c-col>
        </c-row>
        @if (selectedCategory()) {
          <div class="mt-3">
            <c-badge color="info" class="me-2">
              <svg cIcon name="cilFilter" size="sm" class="me-1"></svg>
              {{ selectedCategory() }}
            </c-badge>
            <button
              cButton
              color="link"
              size="sm"
              class="p-0"
              (click)="onCategoryChange(null)"
            >
              Clear filter
            </button>
          </div>
        }
      </c-card-body>
    </c-card>

    <!-- Providers Grid -->
    @if (filteredProviders().length > 0) {
      <c-row>
        @for (provider of filteredProviders(); track provider.id) {
          <c-col xs="12" md="6" lg="4" class="mb-4">
            <c-card class="h-100">
              <c-card-body class="text-center">
                @if (provider.avatar) {
                  <c-avatar
                    [src]="'./assets/images/avatars/' + provider.avatar"
                    size="xl"
                    class="mb-3"
                  ></c-avatar>
                } @else {
                  <div
                    class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary text-white mb-3"
                    style="width: 80px; height: 80px; font-size: 2rem; font-weight: bold;"
                  >
                    {{ provider.name.charAt(0) }}
                  </div>
                }
                <h5 class="card-title mb-2">{{ provider.name }}</h5>
                <c-badge
                  [color]="provider.type === 'Agency' ? 'primary' : 'success'"
                  class="mb-3"
                >
                  {{ provider.type }}
                </c-badge>
                @if (provider.description) {
                  <p class="text-muted small mb-3">{{ provider.description }}</p>
                }
                <div class="mb-3">
                  @for (skill of provider.skills; track skill) {
                    <c-badge color="info" class="me-1 mb-1">{{ skill }}</c-badge>
                  }
                </div>
                <div class="d-flex justify-content-center mb-3">
                  <div class="d-flex align-items-center">
                    <svg cIcon name="cilStar" class="text-warning me-1"></svg>
                    <strong>{{ provider.rating }}</strong>
                  </div>
                </div>
                <button
                  cButton
                  color="primary"
                  variant="outline"
                  class="w-100"
                  [routerLink]="['/marketplace/contractors', provider.id]"
                >
                  <svg cIcon name="cilInfo" class="me-2"></svg>
                  View Details
                </button>
              </c-card-body>
            </c-card>
          </c-col>
        }
      </c-row>
    } @else {
      <c-card>
        <c-card-body class="text-center py-5">
          <svg cIcon name="cilInbox" size="3xl" class="text-muted mb-3"></svg>
          <h5 class="text-muted">No providers found</h5>
          <p class="text-muted">
            @if (searchQuery() || selectedCategory()) {
              Try adjusting your search or filter criteria.
            } @else {
              No providers available at the moment.
            }
          </p>
          @if (searchQuery() || selectedCategory()) {
            <button
              cButton
              color="primary"
              variant="outline"
              (click)="onCategoryChange(null); searchQuery.set('')"
            >
              Clear Filters
            </button>
          }
        </c-card-body>
      </c-card>
    }

    <!-- Contractor Users Section -->
    @if (contractors().length > 0) {
      <c-row class="mt-4">
        <c-col xs="12">
          <h4 class="mb-3">Contractor Users</h4>
        </c-col>
      </c-row>
      <c-row>
        @for (contractor of contractors(); track contractor.id) {
          <c-col xs="12" md="6" lg="4" class="mb-4">
            <c-card class="h-100">
              <c-card-body class="text-center">
                @if (contractor.avatar) {
                  <c-avatar
                    [src]="'./assets/images/avatars/' + contractor.avatar"
                    size="xl"
                    class="mb-3"
                  ></c-avatar>
                } @else {
                  <div
                    class="d-inline-flex align-items-center justify-content-center rounded-circle bg-warning text-white mb-3"
                    style="width: 80px; height: 80px; font-size: 2rem; font-weight: bold;"
                  >
                    {{ contractor.name.charAt(0) }}
                  </div>
                }
                <h5 class="card-title mb-2">{{ contractor.name }}</h5>
                <c-badge color="warning" class="mb-3">
                  Contractor
                </c-badge>
                @if (contractor.contractorProfile?.useCases && (contractor.contractorProfile?.useCases?.length ?? 0) > 0) {
                  <div class="mb-3">
                    @for (useCase of contractor.contractorProfile!.useCases!.slice(0, 3); track useCase) {
                      <c-badge color="info" class="me-1 mb-1">{{ useCase }}</c-badge>
                    }
                  </div>
                }
                <button
                  cButton
                  color="primary"
                  variant="outline"
                  class="w-100"
                  [routerLink]="['/marketplace/contractors', contractor.id]"
                >
                  <svg cIcon name="cilInfo" class="me-2"></svg>
                  View Profile
                </button>
              </c-card-body>
            </c-card>
          </c-col>
        }
      </c-row>
    }
  </c-col>
</c-row>

<!-- Delete Confirmation Modal (Super Admin only) -->
@if (isSuperAdmin()) {
  <c-modal [visible]="showDeleteConfirm()" (visibleChange)="showDeleteConfirm.set($event)">
    <c-modal-header>
      <h5 cModalTitle>Confirm Delete</h5>
      <button cButtonClose (click)="cancelDelete()"></button>
    </c-modal-header>
    <c-modal-body>
      <p>Are you sure you want to delete this contractor? This action cannot be undone.</p>
    </c-modal-body>
    <c-modal-footer>
      <button cButton color="secondary" (click)="cancelDelete()">Cancel</button>
      <button cButton color="danger" (click)="deleteContractor()">
        Delete
      </button>
    </c-modal-footer>
  </c-modal>
}
